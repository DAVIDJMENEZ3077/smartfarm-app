<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pesos Semanales - Finca Camaronera</title>
<style>
  :root{--bg:#0b1320;--card:#121c2e;--ink:#e9f0ff;--muted:#9fb0d1;--accent:#2fd29a;--accent2:#3ea0ff;--danger:#ff5d5d}
  *{box-sizing:border-box}
  html,body{overscroll-behavior-y:none;touch-action:manipulation}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;background:var(--bg);color:var(--ink)}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid #1c2942;border-radius:18px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:16px}
  h1,h2{margin:.2em 0 .5em} h1{font-size:1.35rem} h2{font-size:1.2rem;color:var(--muted)}
  label{display:block;font-size:.95rem;margin:.4rem 0 .25rem;color:var(--muted)}
  input,button,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #223356;background:#0d1729;color:#e9f0ff;outline:none}
  input:focus,textarea:focus,select:focus{border-color:var(--accent2)}
  button:disabled{opacity:.55;cursor:not-allowed}
  .row{display:grid;gap:12px}
  .row.cols-1{grid-template-columns:1fr}
  .row.fixed-2{grid-template-columns:1fr 1fr}
  .row.cols-2{grid-template-columns:1fr 1fr}
  .row.cols-3{grid-template-columns:1fr 1fr 1fr}
  @media (max-width:720px){.row.cols-2,.row.cols-3{grid-template-columns:1fr 1fr}}
  @media (max-width:480px){.row.cols-2,.row.cols-3{grid-template-columns:1fr}.row.fixed-2{grid-template-columns:1fr 1fr}}
  table{width:100%;border-collapse:separate;border-spacing:0 8px;margin:8px 0 6px}
  th,td{padding:10px;border-top:1px solid #203050;border-bottom:1px solid #203050;background:#0e182b}
  th{font-weight:600;color:#bcd1ff;background:#0f1b31} td input{width:100%}
  .btn{cursor:pointer;transition:.15s;border:1px solid #234;display:inline-flex;align-items:center;justify-content:center;gap:8px}
  .btn:hover{transform:translateY(-1px)}
  .btn.accent{background:var(--accent);color:#052d1e;border-color:#0d805c}
  .btn.secondary{background:#0f2038;color:var(--ink);border-color:#274064}
  .btn.ghost{background:transparent;border-color:#2a3e63}
  .btn.warn{background:var(--danger);border-color:#b62828}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .pill{padding:8px 12px;border-radius:12px;background:#0e1d34;border:1px solid #263a5c;color:#cfe0ff;font-size:.9rem}
  .note{font-size:.9rem;color:#a9beda}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .sep{height:1px;background:#22324e;margin:14px 0}
  .right{margin-left:auto}
  .hidden{display:none !important}
  .control{height:48px;background:#0f2038;border:1px solid #274064;color:#e9f0ff;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;gap:8px;font-size:16px}
  @keyframes pulseRec{0%{box-shadow:0 0 0 0 rgba(255,93,93,.65)}70%{box-shadow:0 0 0 10px rgba(255,93,93,0)}100%{box-shadow:0 0 0 0 rgba(255,93,93,0)}}
  .control.recording{background:#6e2630;border-color:#ff7a7a;color:#fff;animation:pulseRec 1.1s infinite}
  .control.recording::before{content:"‚óè";margin-right:8px;color:#ffb5b5;font-size:14px}
  .flag-btn{width:44px;height:44px;border-radius:12px;font-weight:800;font-size:22px;border:2px solid #2b415f;user-select:none}
  .flag-on{background:#0f2b40;border-color:#3ec6ff;color:#bfe8ff}
  .flag-off{background:#6e2630;border-color:#ff7a7a;color:#fff}
  tr.excluded td{background:#0b1626}
  tr.excluded td input{opacity:.65}
  tr.excluded td:nth-child(3) input{opacity:1}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000;padding:12px;overflow:auto}
  .modal{width:min(900px,100%);background:var(--card);border:1px solid #1c2942;border-radius:18px;padding:16px;box-shadow:0 18px 60px rgba(0,0,0,.45);max-height:92vh;overflow:auto;position:relative}
  .modal h3{margin:0 0 12px}
  #fotoOverlay{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:1200;padding:16px}
  #fotoOverlay img{max-width:100%;max-height:calc(100vh - 110px);border-radius:12px;border:1px solid #2a3e63;background:#0e182b;display:block}
  #btnCloseFoto{margin-top:12px}
  /* Banner de errores */
  #errBanner{position:fixed;left:0;right:0;top:0;background:#8b1e1e;color:#fff;padding:6px 10px;font-size:12px;z-index:2000;display:none}
</style>
</head>
<body>
<div id="errBanner"></div>
<div class="wrap">
  <!-- Configuraci√≥n inicial -->
  <div class="card" id="screen-setup">
    <h1>Pesos semanales ‚Äì Configuraci√≥n inicial</h1>
    <div class="row cols-3">
      <div><label>Nombre de la finca</label><input id="finca" placeholder="Ej. Palmilla / El Roble"/></div>
      <div><label>Fecha de muestreo</label><input id="fecha" type="date"/></div>
      <div><label>N√∫mero de piscinas a muestrear</label><input id="numPiscinas" type="number" min="1" step="1" placeholder="Ej. 8"/></div>
    </div>
    <div class="btn-row" style="margin-top:12px">
      <button class="btn accent" id="btnStart">Generar</button>
      <span class="note">Se crear√° una pantalla por piscina (01‚Ä¶N).</span>
    </div>
  </div>

  <!-- Pantalla por piscina -->
  <div class="card hidden" id="screen-pond">
    <div class="inline">
      <h1 id="pondTitle">Piscina 01</h1>
      <span class="pill" id="pillProgress">1 / 1</span>
      <span class="pill right">Finca: <span id="pillFinca"></span></span>
      <span class="pill">Fecha: <span id="pillFecha"></span></span>
    </div>

    <div class="row cols-1" style="margin-top:10px">
      <div><label>Nombre/ID de la piscina</label><input id="pondName"/></div>
    </div>
    <div class="row fixed-2" style="margin-top:2px">
      <div><label>Peso semana pasada (g)</label><input id="pesoSemanaPasada" type="number" inputmode="decimal" step="0.01" placeholder="Ej. 10.5"/></div>
      <div><label>Peso media semana (g)</label><input id="pesoMediaSemana" type="number" inputmode="decimal" step="0.01" placeholder="Ej. 11.2"/></div>
    </div>

    <h2 style="margin-top:10px">Muestreo</h2>
    <div class="row fixed-2" style="margin:6px 0">
      <button class="btn ghost" id="btnAddRow">+ Agregar fila</button>
      <button class="btn ghost" id="btnRemoveRow">‚àí Quitar √∫ltima</button>
    </div>
    <span class="note">Usa ‚úì/X para incluir o excluir filas. Doble clic limpia la fila.</span>

    <table>
      <thead>
        <tr>
          <th style="width:28%"># de animales</th>
          <th style="width:28%">gr muestra</th>
          <th style="width:22%">Peso (g)</th>
          <th style="width:22%">Agregar / Quitar</th>
        </tr>
      </thead>
      <tbody id="rowsBody"></tbody>
    </table>

    <div class="inline" style="gap:16px;margin:10px 0">
      <button class="btn secondary" id="btnCalcular">Calcular promedio</button>
      <span class="pill">Œ£ animales: <strong id="sumN">0</strong></span>
      <span class="pill">Œ£ gr muestra: <strong id="sumG">0.00</strong></span>
      <span class="pill">Peso actual (g): <strong id="pesoActual">0.00</strong></span>
    </div>

    <div class="row cols-3" style="margin-top:6px">
      <div><label>Crecimiento semanal (g)</label><input id="crecSem" readonly/></div>
      <div><label>Crecimiento media semana (g)</label><input id="crecMedia" readonly/></div>
      <div><label>Observaciones (texto opcional)</label><input id="obsTexto" placeholder="Breve nota‚Ä¶"/></div>
    </div>

    <div class="sep"></div>

    <h2>Observaciones por voz e imagen (opcional)</h2>
    <div class="row fixed-2">
      <div>
        <label>Grabar observaci√≥n de voz</label>
        <button class="btn control" id="btnRecToggle">üéôÔ∏è Grabar</button>
      </div>
      <div>
        <label>Tomar foto de los camarones</label>
        <button id="btnFoto" class="btn control" title="Tomar foto">üì∑ Tomar foto</button>
        <input id="fotoHidden" type="file" accept="image/*" capture="environment" class="hidden"/>
      </div>
    </div>

    <div class="sep"></div>

    <div class="btn-row">
      <button class="btn" id="btnGuardar">üíæ Guardar</button>
      <button class="btn accent" id="btnSeguir">‚û°Ô∏è Seguir</button>
      <button class="btn ghost" id="btnVerMuestreo">üëÅÔ∏è Ver muestreo</button>
      <button class="btn ghost" id="btnAddPond">+ A√±adir piscina</button>
      <button class="btn ghost" id="btnRepeatPond">‚ü≤ Repetir esta piscina</button>
      <button class="btn ghost right" id="btnDescargar">‚¨áÔ∏è Descargar CSV (acumulado)</button>
      <button class="btn warn" id="btnReiniciar">üóëÔ∏è Reiniciar</button>
    </div>
  </div>
</div>

<!-- Modal Resumen Muestreo -->
<div class="modal-backdrop" id="modalMuestreo">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="muestreoTitle">
    <h3 id="muestreoTitle">Resumen de muestreo (vista r√°pida)</h3>
    <table>
      <thead>
        <tr>
          <th>Piscina</th>
          <th>Peso actual (g)</th>
          <th>Crec. semanal (g)</th>
          <th>Crec. media semana (g)</th>
        </tr>
      </thead>
      <tbody id="muestreoBody"></tbody>
    </table>
    <div class="btn-row">
      <button class="btn accent" id="btnCloseMuestreo">Cerrar</button>
    </div>
  </div>
</div>

<!-- Overlay de FOTO -->
<div id="fotoOverlay" class="hidden">
  <img id="fotoOverlayImg" alt="Foto tomada"/>
  <button class="btn accent" id="btnCloseFoto">Cerrar</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // ===== utilidades =====
  function $(s){return document.querySelector(s)}
  function fmt2(v){return (isFinite(v)?Number(v).toFixed(2):"0.00")}
  function pad2(n){return String(n).padStart(2,'0')}
  function sanitize(s){return String(s).replace(/[^\w\-]+/g,"_")}
  function topSmooth(){window.scrollTo({top:0,behavior:'smooth'})}

  // ===== banner de errores para depurar en cualquier equipo =====
  (function(){
    var banner = $("#errBanner");
    window.addEventListener("error", function(e){
      banner.textContent = "Error: " + (e.message||"") + "  ("+(e.filename||"") + ":" + (e.lineno||"") + ")";
      banner.style.display = "block";
    });
    window.addEventListener("unhandledrejection", function(e){
      banner.textContent = "Error promesa: " + (e.reason&&e.reason.message?e.reason.message:e.reason);
      banner.style.display = "block";
    });
  })();

  // ===== estado =====
  var state = {
    finca:"", fecha:"", totalPiscinas:0, idx:0,
    resultados:[],
    audioBlob:null, audioUrl:"", audioFileName:"",
    fotoFile:null, fotoUrl:"", fotoFileName:""
  };

  // ===== elementos =====
  var screenSetup=$("#screen-setup"), screenPond=$("#screen-pond");
  var finca=$("#finca"), fecha=$("#fecha"), numPiscinas=$("#numPiscinas"), btnStart=$("#btnStart");
  var pondTitle=$("#pondTitle"), pillProgress=$("#pillProgress"), pillFinca=$("#pillFinca"), pillFecha=$("#pillFecha");
  var pondName=$("#pondName"), pesoSemanaPasada=$("#pesoSemanaPasada"), pesoMediaSemana=$("#pesoMediaSemana");
  var rowsBody=$("#rowsBody"), btnAddRow=$("#btnAddRow"), btnRemoveRow=$("#btnRemoveRow");
  var sumN=$("#sumN"), sumG=$("#sumG"), pesoActual=$("#pesoActual");
  var crecSem=$("#crecSem"), crecMedia=$("#crecMedia"), obsTexto=$("#obsTexto");
  var btnRecToggle=$("#btnRecToggle"), btnFoto=$("#btnFoto"), fotoHidden=$("#fotoHidden");
  var fotoOverlay=$("#fotoOverlay"), fotoOverlayImg=$("#fotoOverlayImg"), btnCloseFoto=$("#btnCloseFoto");
  var btnGuardar=$("#btnGuardar"), btnSeguir=$("#btnSeguir"), btnAddPond=$("#btnAddPond"), btnRepeatPond=$("#btnRepeatPond");
  var btnVerMuestreo=$("#btnVerMuestreo"), btnDescargar=$("#btnDescargar"), btnReiniciar=$("#btnReiniciar");
  var modal=$("#modalMuestreo"), muestreoBody=$("#muestreoBody"), btnCloseMuestreo=$("#btnCloseMuestreo");

  // fecha por defecto (compatibilidad)
  try{ fecha.valueAsDate = new Date(); }catch(_){}

  // ===== antireinicio =====
  var guardActive=false;
  function shouldWarn(){
    if (screenPond.classList.contains('hidden')) return false;
    if (state.resultados.filter(Boolean).length>0) return true;
    if (pondName.value.trim() || pesoSemanaPasada.value || pesoMediaSemana.value || obsTexto.value.trim()) return true;
    var has=false;
    rowsBody.querySelectorAll('tr').forEach(function(tr){
      if ((tr.querySelector('.n').value||'').trim() || (tr.querySelector('.g').value||'').trim()) has=true;
    });
    return has;
  }
  function beforeUnloadHandler(e){
    if (shouldWarn()){ e.preventDefault(); e.returnValue=''; }
  }
  function activateGuards(){
    if(guardActive) return;
    guardActive=true;
    window.addEventListener('beforeunload', beforeUnloadHandler);
    // simple guard para bot√≥n/gesto atr√°s
    try{
      history.pushState({g:true}, document.title, location.href);
      window.addEventListener('popstate', function(){
        if(!guardActive){ history.back(); return; }
        if(shouldWarn()){
          if(confirm('¬øDesea reiniciar el programa? Se perder√°n datos no descargados.')){
            guardActive=false;
            window.removeEventListener('beforeunload', beforeUnloadHandler);
            history.back();
          }else{
            history.pushState({g:true}, document.title, location.href);
          }
        }else{
          guardActive=false; history.back();
        }
      });
    }catch(_){}
  }

  // ===== filas =====
  function createRow(){
    var tr=document.createElement("tr");
    tr.innerHTML = ''+
      '<td><input type="number" inputmode="numeric" step="1" min="0" class="n"/></td>'+
      '<td><input type="number" inputmode="decimal" step="0.01" min="0" class="g"/></td>'+
      '<td><input type="text" class="ga" value="0.00" readonly/></td>'+
      '<td style="text-align:center"><button type="button" class="flag-btn flag-on" title="Incluir fila">‚úì</button></td>';
    tr.querySelector(".n").addEventListener("input", recalcFilas);
    tr.querySelector(".g").addEventListener("input", recalcFilas);
    var flag=tr.querySelector(".flag-btn");
    flag.addEventListener("click", function(){
      var on=flag.classList.contains("flag-on");
      if(on){ flag.classList.remove("flag-on"); flag.classList.add("flag-off"); flag.textContent="X"; tr.classList.add("excluded"); }
      else { flag.classList.remove("flag-off"); flag.classList.add("flag-on"); flag.textContent="‚úì"; tr.classList.remove("excluded"); }
      actualizarSumaYPromedio();
    });
    flag.addEventListener("dblclick", function(){
      tr.querySelector(".n").value=""; tr.querySelector(".g").value=""; tr.querySelector(".ga").value="0.00";
      flag.classList.remove("flag-off"); flag.classList.add("flag-on"); flag.textContent="‚úì"; tr.classList.remove("excluded");
      actualizarSumaYPromedio();
    });
    return tr;
  }
  function construirFilas(){
    rowsBody.innerHTML=""; for(var i=0;i<5;i++){ rowsBody.appendChild(createRow()); }
    actualizarSumaYPromedio();
  }
  function recalcFilas(){
    rowsBody.querySelectorAll("tr").forEach(function(tr){
      var n=parseFloat(tr.querySelector(".n").value||0);
      var g=parseFloat(tr.querySelector(".g").value||0);
      tr.querySelector(".ga").value = (isFinite(n)&&n>0) ? (g/n).toFixed(2) : "0.00";
    });
    actualizarSumaYPromedio();
  }
  function actualizarSumaYPromedio(){
    var sN=0,sG=0;
    rowsBody.querySelectorAll("tr").forEach(function(tr){
      if(tr.classList.contains("excluded")) return;
      sN += parseFloat(tr.querySelector(".n").value||0);
      sG += parseFloat(tr.querySelector(".g").value||0);
    });
    sumN.textContent=sN;
    sumG.textContent=(+sG).toFixed(2);
    var avg=(sN>0)?(sG/sN):0;
    pesoActual.textContent=(+avg).toFixed(2);
    var psp=parseFloat(pesoSemanaPasada.value||0), pms=parseFloat(pesoMediaSemana.value||0);
    crecSem.value=(avg-psp).toFixed(2);
    crecMedia.value=(avg-pms).toFixed(2);
  }

  // ===== navegaci√≥n inicial =====
  btnStart.addEventListener("click", function(){
    var nf=finca.value.trim(), fd=fecha.value, nP=parseInt(numPiscinas.value,10);
    if(!nf){alert("Ingresa el nombre de la finca.");return;}
    if(!fd){alert("Selecciona la fecha de muestreo.");return;}
    if(!nP||nP<1){alert("Ingresa un n√∫mero v√°lido de piscinas.");return;}
    state.finca=nf; state.fecha=fd; state.totalPiscinas=nP; state.idx=0; state.resultados=[];
    pillFinca.textContent=state.finca; pillFecha.textContent=state.fecha;
    screenSetup.classList.add("hidden"); screenPond.classList.remove("hidden");
    cargarPiscinaActual(true); topSmooth();
    activateGuards();
  });

  // ===== carga de piscina =====
  function cargarPiscinaActual(reset){
    var num=state.idx+1;
    pondTitle.textContent="Piscina "+pad2(num);
    pondName.value="Piscina "+pad2(num);
    pillProgress.textContent= num+" / "+state.totalPiscinas;
    if(reset){
      pesoSemanaPasada.value=""; pesoMediaSemana.value=""; obsTexto.value="";
      // reset multimedia
      try{ if(state.audioUrl){ URL.revokeObjectURL(state.audioUrl); } }catch(_){}
      state.audioBlob=null; state.audioUrl=""; state.audioFileName="";
      btnRecToggle.dataset.recording="false"; btnRecToggle.textContent="üéôÔ∏è Grabar"; btnRecToggle.classList.remove("recording");
      state.fotoFile=null; state.fotoUrl=""; state.fotoFileName=""; fotoHidden.value="";
      fotoOverlay.classList.add("hidden");
    }
    construirFilas();
  }

  // ===== botones de filas =====
  btnAddRow.addEventListener("click", function(){ rowsBody.appendChild(createRow()); actualizarSumaYPromedio(); });
  btnRemoveRow.addEventListener("click", function(){ var last=rowsBody.lastElementChild; if(last){ rowsBody.removeChild(last); actualizarSumaYPromedio(); } });

  // ===== audio (toggle) =====
  var mediaRecorder=null, chunks=[];
  function startRecording(){
    return navigator.mediaDevices.getUserMedia({audio:true}).then(function(stream){
      mediaRecorder=new MediaRecorder(stream); chunks=[];
      mediaRecorder.ondataavailable=function(e){ if(e.data && e.data.size>0) chunks.push(e.data); };
      mediaRecorder.onstop=function(){
        var blob=new Blob(chunks,{type:"audio/webm"});
        state.audioBlob=blob; state.audioUrl=URL.createObjectURL(blob);
        state.audioFileName = sanitize(state.finca+"_"+state.fecha+"_"+pondName.value+"_obsAudio")+".webm";
      };
      mediaRecorder.start();
    });
  }
  function stopRecording(){ if(mediaRecorder && mediaRecorder.state!=="inactive"){ mediaRecorder.stop(); } }
  btnRecToggle.addEventListener("click", function(){
    var rec = btnRecToggle.dataset.recording==="true";
    if(!rec){
      if(!navigator.mediaDevices || !window.MediaRecorder){ alert("Grabaci√≥n no soportada en este dispositivo/navegador."); return; }
      startRecording().then(function(){
        btnRecToggle.dataset.recording="true"; btnRecToggle.textContent="‚èπÔ∏è Detener"; btnRecToggle.classList.add("recording");
      }).catch(function(err){ alert("No se pudo iniciar la grabaci√≥n: "+err.message); });
    }else{
      stopRecording();
      btnRecToggle.dataset.recording="false"; btnRecToggle.textContent="üéôÔ∏è Grabar"; btnRecToggle.classList.remove("recording");
    }
  });

  // ===== foto =====
  btnFoto.addEventListener("click", function(){ fotoHidden.click(); });
  fotoHidden.addEventListener("change", function(){
    var f = fotoHidden.files && fotoHidden.files[0]; if(!f) return;
    state.fotoFile=f; state.fotoUrl=URL.createObjectURL(f);
    var ext=(f.name.split(".").pop()||"jpg").toLowerCase();
    state.fotoFileName=sanitize(state.finca+"_"+state.fecha+"_"+pondName.value+"_foto")+"."+ext;
    fotoOverlayImg.src=state.fotoUrl;
    fotoOverlay.classList.remove("hidden");
    fotoOverlay.style.display="flex";
  });
  btnCloseFoto.addEventListener("click", function(){ fotoOverlay.classList.add("hidden"); fotoOverlay.style.display="none"; });
  fotoOverlay.addEventListener("click", function(e){ if(e.target===fotoOverlay){ fotoOverlay.classList.add("hidden"); fotoOverlay.style.display="none"; } });

  // ===== construir registro / guardar por √≠ndice (sin duplicados) =====
  function construirRegistro(){
    var pName=pondName.value.trim(); if(!pName){ alert("Ingresa el nombre/ID de la piscina."); return null; }
    var sN=0,sG=0;
    rowsBody.querySelectorAll("tr").forEach(function(tr){
      if(tr.classList.contains("excluded")) return;
      sN += parseFloat(tr.querySelector(".n").value||0);
      sG += parseFloat(tr.querySelector(".g").value||0);
    });
    if(sN<=0){ alert("Debes registrar al menos un # de animales > 0 (incluido)."); return null; }
    var avg=sG/sN, psp=parseFloat(pesoSemanaPasada.value||0), pms=parseFloat(pesoMediaSemana.value||0);
    var audioName="",audioHref="",fotoName="",fotoHref="";
    if(state.audioBlob && state.audioUrl){ audioName=state.audioFileName||"observacion.webm"; audioHref=state.audioUrl; }
    if(state.fotoFile && state.fotoUrl){ fotoName=state.fotoFileName||state.fotoFile.name; fotoHref=state.fotoUrl; }
    return {
      finca: state.finca, fecha_muestreo: state.fecha, piscina: pName,
      total_animales_sum: sN, total_gr_muestra_sum: +sG.toFixed(2),
      peso_actual_g: +avg.toFixed(2),
      peso_semana_pasada_g: +(psp).toFixed(2), peso_media_semana_g: +(pms).toFixed(2),
      crecimiento_semanal_g: +(avg-psp).toFixed(2), crecimiento_media_semana_g: +(avg-pms).toFixed(2),
      observaciones_texto: obsTexto.value.trim(),
      observaciones_transcripcion: "(pendiente)", observaciones_resumen: "",
      audio_nombre: audioName, audio_url_local: audioHref, foto_nombre: fotoName, foto_url_local: fotoHref
    };
  }
  function guardarEnIndiceActual(modo){
    var registro=construirRegistro(); if(!registro) return false;
    var yaHabia = !!state.resultados[state.idx];
    state.resultados[state.idx] = registro;
    if(modo==="seguir") return true;
    alert((yaHabia? "Actualizado":"Guardado")+": "+registro.piscina+" (peso="+registro.peso_actual_g+" g)");
    return true;
  }

  $("#btnCalcular").addEventListener("click", actualizarSumaYPromedio);
  btnGuardar.addEventListener("click", function(){ guardarEnIndiceActual("manual"); });
  btnSeguir.addEventListener("click", function(){
    if(!guardarEnIndiceActual("seguir")) return;
    if(state.idx < state.totalPiscinas-1){
      state.idx += 1; cargarPiscinaActual(true); requestAnimationFrame(topSmooth);
    }else{
      alert("¬°Listo! Ya registraste todas las piscinas. Si necesitas agregar m√°s, usa ‚Äú+ A√±adir piscina‚Äù o ‚ÄúRepetir esta piscina‚Äù.");
      topSmooth();
    }
  });

  // ===== a√±adir / repetir =====
  btnAddPond.addEventListener("click", function(){
    state.totalPiscinas += 1;
    pillProgress.textContent = (state.idx+1)+" / "+state.totalPiscinas;
    alert("Se a√±adi√≥ 1 piscina al plan. Pulsa Seguir para continuar cuando est√©s listo.");
  });
  btnRepeatPond.addEventListener("click", function(){
    var baseName=(pondName.value.trim() || ("Piscina "+pad2(state.idx+1))) + " (rep)";
    state.totalPiscinas += 1; state.idx = state.totalPiscinas - 1;
    cargarPiscinaActual(true); pondName.value = baseName;
    pillProgress.textContent = (state.idx+1)+" / "+state.totalPiscinas;
    topSmooth();
  });

  // ===== ver muestreo =====
  function construirRegistroPreview(){
    var sN=0,sG=0;
    rowsBody.querySelectorAll("tr").forEach(function(tr){
      if(tr.classList.contains("excluded")) return;
      sN += parseFloat(tr.querySelector(".n").value||0);
      sG += parseFloat(tr.querySelector(".g").value||0);
    });
    if(sN<=0) return null;
    var avg=sG/sN, psp=parseFloat(pesoSemanaPasada.value||0), pms=parseFloat(pesoMediaSemana.value||0);
    return { piscina:(pondName.value.trim()||("Piscina "+pad2(state.idx+1))), peso_actual_g:+avg.toFixed(2), crecimiento_semanal_g:+(avg-psp).toFixed(2), crecimiento_media_semana_g:+(avg-pms).toFixed(2) };
  }
  function construirTablaMuestreo(){
    muestreoBody.innerHTML="";
    var filas=[];
    state.resultados.filter(Boolean).forEach(function(r){
      filas.push('<tr><td>'+r.piscina+'</td><td>'+fmt2(r.peso_actual_g)+'</td><td>'+fmt2(r.crecimiento_semanal_g)+'</td><td>'+fmt2(r.crecimiento_media_semana_g)+'</td></tr>');
    });
    if(!state.resultados[state.idx]){
      var s=construirRegistroPreview();
      if(s){ filas.push('<tr><td>'+s.piscina+' (en curso)</td><td>'+fmt2(s.peso_actual_g)+'</td><td>'+fmt2(s.crecimiento_semanal_g)+'</td><td>'+fmt2(s.crecimiento_media_semana_g)+'</td></tr>'); }
    }
    muestreoBody.innerHTML = filas.length? filas.join("") : '<tr><td colspan="4">Sin datos a√∫n.</td></tr>';
  }
  btnVerMuestreo.addEventListener("click", function(){ construirTablaMuestreo(); modal.style.display="flex"; });
  btnCloseMuestreo.addEventListener("click", function(){ modal.style.display="none"; });
  modal.addEventListener("click", function(e){ if(e.target===modal){ modal.style.display="none"; } });
  document.addEventListener("keydown", function(e){ if(e.key==="Escape" && modal.style.display==="flex"){ modal.style.display="none"; } });

  // ===== CSV =====
  function aCSV(arr){
    var headers=["finca","fecha_muestreo","piscina","total_animales_sum","total_gr_muestra_sum","peso_actual_g","peso_semana_pasada_g","peso_media_semana_g","crecimiento_semanal_g","crecimiento_media_semana_g","observaciones_texto","observaciones_transcripcion","observaciones_resumen","audio_nombre","audio_url_local","foto_nombre","foto_url_local"];
    function esc(v){ if(v==null) return ""; var s=String(v); return (s.indexOf(",")>-1||s.indexOf("\n")>-1||s.indexOf('"')>-1)?('"'+s.replace(/"/g,'""')+'"'):s; }
    var lines=[headers.join(",")];
    arr.forEach(function(r){ lines.push(headers.map(function(h){return esc(r[h]||"")}).join(",")); });
    return lines.join("\n");
  }
  btnDescargar.addEventListener("click", function(){
    var arr=state.resultados.filter(Boolean);
    if(arr.length===0){ alert("A√∫n no hay registros guardados."); return; }
    var csv=aCSV(arr);
    var blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    var url=URL.createObjectURL(blob);
    var a=document.createElement("a");
    a.href=url; a.download=sanitize(state.finca+"_"+state.fecha+"_pesos")+".csv";
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  });

  // ===== reinicio manual =====
  btnReiniciar.addEventListener("click", function(){
    if(confirm("¬øReiniciar el programa? Se borrar√°n registros no descargados.")){
      window.removeEventListener('beforeunload', beforeUnloadHandler);
      location.reload();
    }
  });
});
</script>
</body>
</html>
